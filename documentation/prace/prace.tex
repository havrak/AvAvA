\documentclass[a4paper,oneside,12pt]{report}
\setlength\textwidth{155mm}
\setlength\textheight{247mm}
\setlength\topmargin{-10mm}
\setlength\headheight{0mm}
\setlength\oddsidemargin{05mm}
\setlength\evensidemargin{05mm}
\let\openright=\clearpage


%% Vytváříme PDF/A-2u
\usepackage[a-2u]{pdfx}

%% Přepneme na českou sazbu a fonty Latin Modern
\usepackage[czech]{babel}
\usepackage{lmodern}
\usepackage[T1]{fontenc}
\usepackage{textcomp}

%% Použité kódování znaků: obvykle latin2, cp1250 nebo utf8:
\usepackage[utf8]{inputenc}

%%% Další užitečné balíčky (jsou součástí běžnýsrov.stribucí LaTeXu)
\usepackage{amsmath}        % rozšíření pro sazbu matematiky
\usepackage{amsfonts}       % matematické fonty
\usepackage{amsthm}         % sazba vět, definic apod.
\usepackage{bbding}         % balíček s nejrůznějšími symboly
			   										% (čtverečky, hvězdičky, tužtičky, nůžtičky, ...)
\usepackage{bm}             % tučné symboly (příkaz \bm)
\usepackage{graphicx}       % vkládání obrázků
\usepackage{fancyhdr}				% možnost slylizovat záhlaví
\usepackage{fancyvrb}       % vylepšené prostředí pro strojové písmo
\usepackage{indentfirst}    % zavede odsazení 1. odstavce kapitoly
\usepackage[nottoc]{tocbibind} % zajistí přidání seznamu literatury,
\usepackage{icomma}         % inteligetní čárka v matematickém módu
\usepackage{dcolumn}        % lepší zarovnání sloupců v tabulkách
\usepackage{booktabs}       % lepší vodorovné linky v tabulkách
\usepackage{paralist}       % lepší enumerate a itemize
\usepackage{caption}				%	popisky
\usepackage{dirtree}				% strom souborů
\usepackage{listings}				% vkládání kódu
\usepackage[bottom]{footmisc}  % poznámky pod čarou vespod
\usepackage{bibentry}
\usepackage{xurl}						% umožní url zalomit všude
\nobibliography*

\usepackage{color}
\usepackage{forest}					% na rodokmeny
\usepackage{natbib}
%\setbibentrystyle{author}

\definecolor{pblue}{rgb}{0.13,0.13,1}
\definecolor{pgreen}{rgb}{0,0.5,0}
\definecolor{pred}{rgb}{0.9,0,0}
\definecolor{pgrey}{rgb}{0.46,0.45,0.48}
\definecolor{apiblue}{HTML}{61AFFE}
\definecolor{apigreen}{HTML}{49CC90}
\definecolor{apicyan}{HTML}{50E3C2} % vím, že cyan je jiná barva % vím, že cyan je jiná barva
\definecolor{apired}{HTML}{F93E3E}
\definecolor{apiyellow}{HTML}{FCA130}
\renewcommand{\baselinestretch}{1.5}
%%% Údaje o práci

\def\NazevSkoly{Gymnázium, Praha 6, Arabská 14}
% Název oboru včetně počátečního 'Obor'.
\def\NazevOboru{Programování}

% Název práce v jazyce práce (přesně podle zadání)
\def\NazevPrace{Kontejnerizační systém pro školní server}

% Název práce v angličtině
\def\NazevPraceEN{Containerization system for school server}

% Název práce v němčině
\def\NazevPraceDE{Containerisierungssystem für Schulserver }

% Jméno autra
\def\AutorPrace{Havránek Kryštof, Vávra Vladimír, Litoš Josef 3.E }

% Rok odevzdání
\def\RokOdevzdani{2021}
% Měsíc odevzdání
\def\MesicOdevzdani{Duben}

% Vedoucí práce: Jméno a příjmení s~tituly
\def\Vedouci{Ing. Daniel Kahoun}

% Nepovinné poděkování (vedoucímu práce, konzultantovi, tomu, kdo
% zapůjčil software, literaturu apod.)
\def\Podekovani{%
\textbf{Poděkování}
}

% Abstrakt (doporučený rozsah cca 80-200 slov; nejedná se o zadání práce)
\def\Abstrakt{%
Cílem práce je vytvořit kontejnerizační systém pro operační systém GNU/Linux.
Ten by měl v jednoduchém a přehledném uživatelském prostředí umožnit žákům vytvořit si vlastný linuxový server.
Na kterém si poté mohou hostovat svoje aplikace, webové stránky, či videohry.
Systém by se měl postarat o to, aby zdroje serveru byly spravedlivě rozdělené mezi jednotlivé uživatele.
}

\def\AbstraktEN{%
Goal of the work is to create containerization system for GNU/Linux operating system.
With its help students should be able to create their own private server in a easy to use webUI.
On such server they will be able to host their applications, websites or video games.
System should also guarantee fair redistribution of server resources.
}
\def\AbstraktDE{%
Ziel des Werk ist ein Containerisierungssystem für das Betriebssystem GNU / Linux zu erstellen.
Es sollte den Schülern ihren eigenen Linux-Server in einer einfachen und übersichtlichen Benutzeroberfläche möglicher zu bilden.
Auf den Server können sie dann ihre Anwendungen, Websites oder Videospiele hosten, ich mag ein Brot.
Das System sollte sich zusichern, damit die Serverressourcen gerecht auf die individuellen Benutzer verteilt würden.
}
% 3 až 5 klíčových slov (doporučeno), každé uzavřeno ve složených závorkách
\def\KlicovaSlova{%
	{linux}, {lxd}, {lxc}, {kontejnery}, {nodejs}, {REST API}, {react js}
}
\def\KlicovaSlovaEN{%
	{linux}, {lxd}, {lxc}, {containers}, {nodejs}, {REST API}, {react js}
}

\def\KlicovaSlovaDE{%
	{linux}, {lxd}, {lxc}, {Schulprojekt}, {nodejs}, {REST API}, {react js}
}

%% Balíček hyperref, kterým jdou vyrábět klikací odkazy v PDF,
%% ale hlavně ho používáme k uložení metadat do PDF (včetně obsahu).
%% Většinu nastavítek přednastaví balíček pdfx.
\hypersetup{unicode}
\hypersetup{breaklinks=true}

%% Definice různých užitečných maker (viz popis uvnitř souboru)
\include{makra}

%% Titulní strana a různé povinné informační strany
\fancypagestyle{plain}{
\fancyhf{}
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0.4pt}
\fancyhead[C]{}
\fancyhead[L]{Ročníková práce -- \NazevSkoly}
\fancyhead[R]{AvAvA}
\fancyfoot[L]{Vypracovali: \AutorPrace	(\NazevOboru)}
\fancyfoot[C]{}
\fancyfoot[R]{\thepage}
}



\begin{document}

\include{titulka}

\tableofcontents


\newpage

\include{uvod}

\pagenumbering{arabic}
\setcounter{page}{1}

\chapter{Architektura}

Jádro práce stojí na lxd, což je kontejnerizační systém zabudovaný přímo do linuxového kernelu.
Jedná se tak o nejvíce efektivní řešení, protože jednotlivé kontejnery mohou sdílet společný kernel.
Jsou tak menší a rychlejší, než kdyby se jednalo o VPS.
Backend s lxd komunikuje prostřednictvím REST API, které lxd přímo podporuje.

Samotný backend je napsán v nodejs a ke svému fungování využívá dva databázové systémy.
Většinu informací ukládá do mySQL databáze, kvůli komplikacím s LXD byla později zavedena mongoDB.

Frontend je psán v ReactJS a s backendem komunikuje prostřednictvím vlastního REST API (jehož podrobná specifikace je uvedena v dokumentaci).
Na frontendu může uživatel v pohodlném prostředí vytvářet nové kontejnery, projekty, či získat informace o jejich aktuálním stavu a mnohé další.


\section{LXD}

\section{Autentifikace}


\section{Sytém kontejnerů}

// limity

\chapter{Frontend}

\chapter{Backend}

\section{Specifikace vlastního API}

\section{API routy}

\subsubsection{\color{apiblue}{GET -- /combindeDataGET}}

a


\subsubsection{\color{apiblue}{GET -- /instances}}

a

\subsubsection{\color{apiblue}{GET -- /instances/createInstanceConfigData}}

a

\subsubsection{\color{apiblue}{GET -- /instaces/\{id\}}}

a

\subsubsection{\color{apicyan}{PATCH -- /instaces/\{id\}}}

a

\subsubsection{\color{apired}{DELETE -- /instaces/\{id\}}}

a

\subsubsection{\color{apiblue}{GET -- /instaces/\{id\}/stateWithHistory}}

a

\subsubsection{\color{apiblue}{GET -- /instaces/\{id\}/console}}

a

\subsubsection{\color{apiblue}{GET -- /instaces/\{id\}/snapshots}}

a

\subsubsection{\color{apigreen}{POST -- /instaces/\{id\}/snapshots}}

a

\subsubsection{\color{apired}{DELETE -- /instaces/\{id\}/snapshots/\{snapshotsid\}}}

a

\subsubsection{\color{apicyan}{PATCH -- /instaces/\{id\}/restore/\{snapshotsid\}}}

a

\subsubsection{\color{apiblue}{GET -- /instaces/\{id\}/export}}

a

\subsubsection{\color{apiyellow}{PUT -- /instaces/import}}

a

\subsubsection{\color{apicyan}{PATCH -- /instaces/\{id\}/start}}

a

\subsubsection{\color{apicyan}{PATCH -- /instaces/\{id\}/stop}}

a

\subsubsection{\color{apicyan}{PATCH -- /instaces/\{id\}/freeze}}

a

\subsubsection{\color{apicyan}{PATCH -- /instaces/\{id\}/unfreeze}}

a

\subsubsection{\color{apiblue}{GET -- /projects}}

a

\subsubsection{\color{apigreen}{POST -- /projects}}

a

\subsubsection{\color{apiblue}{GET -- /projects/stateWithHistory}}

a

\subsubsection{\color{apiblue}{GET -- /projects/\{id\}}}

a

\subsubsection{\color{apicyan}{PATCH -- /projects/\{id\}}}

a

\subsubsection{\color{apired}{DELETE -- /projects/\{id\}}}

a

\subsubsection{\color{apiblue}{GET -- /projects/\{id\}/stateWithHistory}}

a

\subsubsection{\color{apiblue}{GET -- /projects/user}}

a

\subsubsection{\color{apiblue}{GET -- /logout}}

a


\section{Databáze}

Sytém používá dva databázové systémy -- mySQL (mariaDB) a mongoDB.
Dle původních představ měl používat pouze mySQL.
Kvůli komplikacím s lxd, kde nejde zjistit stav zastaveného/vypnutého kontejneru, byla později zavedena mongoDB.

\subsection{mySQL}
Následující sekce se zabývá strukturou mySQL databáze a metodami, které s databází zacházejí.


\begin{figure}[h]
\dirtree{%
.1 src.
.2 services.
.3 sql.
.4 containerSQL.js.
.4 projectSQL.js.
.4 templateSQL.js.
.4 userSQL.js.
}
\caption{soubory s programem týkající se mysql databáze}
\label{fig:sqlClasses}
\end{figure}

Valnou většinu dat projekt ukládá do mySQL databáze, kde je na tento účel vytvořeno aktuálně 10 tabulek.
S databází pracují 4 soubory (viz. \ref{fig:sqlClasses}) \textit{containerSQL} zpracovává věci týkající se uživatelů, \textit{projectSQL} věci týkající se projektů, \textit{templateSQL} věci týkající se šablon a aplikací, v neposlední řadě \textit{userSQL} věci týkající se uživatele.

\subsubsection{Tabulky}

Tato sekce spěšně popíše obsah jednotlivých tabulek. A jejich vztah k ostatním. Kaskádové dependence jsou vždy stejné -- při smazání se smažou, při update se nic neděje.

\vspace{0.3cm}
\noindent
\textbf{appsToInstall} | id | name | description | icon\_path | package\_name |

Tabulka appsToInstall slouží k uložení aplikací, které je možno nainstalovat na kontejner při jeho vytváření.
Nemá žádnou vazbu na další tabulky a s jejími daty zachází třída templateSQL.
Sloupec name obsahuje jméno jaké se má zobrazit uživateli, package\_name je jméno balíčku v repositářích.

\vspace{0.3cm}
\noindent
\textbf{containers} | id | project\_id | name | url | template\_id | state | timestamp \linebreak[4] | time\_started |

Tabulka container ukládá všechny kontejnery, které spravujeme.
Obsahuje dva cizí klíče a to project\_id, které určuje do jakého projektu kontejner patří, a template\_id to určuje s jakou šablonou byl kontejner vytvořen.


\vspace{0.3cm}
\noindent
\textbf{containersResourcesLimits} | container\_id | ram | cpu | disk | upload | download |

Tabulka containersResourcesLimits ukládá limity kontejneru, stejně jako u dalších .*ResourcesLimits tabulek byla v rámci normalizačních forem oddělena od tabulky containers.
Tabulka obsahuje jeden cizí klíč, který zároveň funguje i jako primární klíč.
Veškeré limity jsou uloženy v základních jednotkách, cpu je v abstraktní jednotce herz.

\vspace{0.3cm}
\noindent
\textbf{containersResourcesLog} | container\_id | ram | cpu | number\_of\_processes | upload | download | timestamp |

Tabulka containersResourcesLog slouží k logování stavu kontejnerů.
Container\_id je cizím klíčem odkazující na kontejner, ke kterému log patří.
V aktuální verzi jsou data uložen v poli, které uložené ve sloupci s typem text.
Timestamp odkazuje na datum posledního zapsání, kdy byl zalogován předchozí stav není problém zjistit, jelikož se do tabulky zapisuje v pravidelných intervalech.

Metoda na updateování stavu (updateLogsForContainer(id, state)) si jednoduše data rozdělí dle znaku: \textbf{,}.
Do pole se přidají nové hodnoty a odebere se první prvek, nový stav se pak uloží do databáze.

Data se aktuálně do databáze uloží každých 10 minut, o což se stará cronjob (potažmo schedule) definovaný v app.js.
Aktuálně si databáze pamatuje dvanáct záznamů, takže dvě hodiny do minulosti.
Fakt, že log časový rozdíl mezi zápisy nemusí být přesně 10 minut, příliš nevadí, grafy, které se z těchto dat vykreslují jsou spíše orientační.


\vspace{0.3cm}
\noindent
\textbf{projects} | id | name | owner\_email | timestamp |

Tabulka projects si pamatuje všechny projekty, které spravuje náš systém.
Cizím klíčem je owner\_email, což je email vlastníka projektu, tedy člověka, který ho vytvořil.
Timestamp je čas vytvoření projektu.

\vspace{0.3cm}
\noindent
\textbf{projectsCoworkers} | project\_id | user\_email |

Tabulka projectsCoworkers zporstředkovává M:N vazbu mezi users a projects.
Slouží k uložení lidí, kteří jsou spolupracovnící na jednom projektu.
K datu odevzdání práce, nejsou spolupracovnící implementované, takže tabulka je aktuálně zbytečná.
Řada metoda nepočítá s existencí spolupracovníků.

\vspace{0.3cm}
\noindent
\textbf{projectsResourcesLimits} | project\_id | ram | cpu | disk | upload | download |

Tabulka projectsResourcesLimits slouží k uložení limitů projektu.
Nerozdíl od containersResourcesLimits můžou zde mít limity hodnotu null.
V takovém případě je kontejnerům dostupný vešerý volný prostor, který uživatel má.

\vspace{0.3cm}
\noindent
\textbf{templates} | code | id | profile\_name | image\_name | version | profile\_description | image\_description | profile\_path | min\_disk\_size |

Tabulka templates slouží k uložení šablon, lde kterých se má vytvořit kontejner.
Šablona je koncept, který se nenachází přímo v lxd, ale integruje dvě věci -- profily a image.
Image je distribuce jaká se na systém má nainstalovat.
Profile je koncept z lxd, který obsahuje konfiguraci kontejneru.
Eventuálně by měl uživatel možnost vytvářet si vlastní profily, které by obsahovali například konfiguraci networků.

\vspace{0.3cm}
\noindent
\textbf{users} | id | email | given\_name | family\_name | icon | role | coins |

Tabulka users slouží k uložení uživatelů.
Svoje data dostává z dat, které zasílá google auth 2.0.
Sloupce role a coins aktuálně nemají význam, role bude dělit uživatele mezi standardního uživatel, admina a superadmin.
Admin a superadmin by měli právo zasahovat do kontejnerů jiných uživatelů.
Coins měl být sloupec sloužící u ekonomiky systému, k její implementaci však nedošlo.


\vspace{0.3cm}
\noindent
\textbf{usersResourcesLimits} | user\_id | ram | cpu | disk | upload | download |

Tabulka usersResourcesLimits ukládá limity uživatelů.
Aktuálně má uživatel k dispozici 2.8 GHz\footnote{server kde byl program vyvíjen měl 2 jádra o 2.8 GHz, jedná se tak o polovinu výkonu}, 1 GB ram, 8GB volného místa na disku, a download a upload 800kb/s.

\subsection{mongoDB}


\section{LXD}

\section{Proxy}

Následující sekce se zabývá networkingem kontejnerů a proxy, které umožňuje přístup na ně z venčí.

\subsection{Konfigurace networků}

Pomineme li loopback (standardní \textit{lo}), tak každý kontejner má v aktuální verzi právě jeden networkový interface.
Tím je \textit{eth0}, který je na hostovacím stroji napojen na bridge \textit{lxdbr0}.
Přes něj mají kontejnery přístup na internet.
Zároveň jsou všechny na stejné síti (prostřednictvím \textit{lxdbr0})

Jelikož jsou veškeré kontejnery na stejné síti, tak mezi sebou mohou komunikovat.
Lxd pro tento účel samo nastavuje jejich interní doménu, ta je ve tvaru \textit{c\{id\}.lxd}.
Pochopitelně však nejsou dostupné z internetu, doména je pouze interní a veřejnou ip adresu nemají.
Aby bylo možno na kontejner přistupovat bylo nutné nastavit proxy, které mu databáze bude přeposílat.

Nutno podotknout, že i traffic mezi kontejnery je aktuálně omezen limitem.
V budoucno se tedy nabízí možnost implementovat možnost vytvářet další bridge a kontejnery si propojovat.
Ty by se mohly ukládat do profilů, uživatel by si tak rovnou mohl vytvořit kontejnerů izolovaný od ostatních.

Fakt, že kontejnery jsou na stejné síti není rizikové ani problematické.
Standartě se nemůžou nijak ovlivňovat.

\subsection{Proxy}

Pro proxy využívá projekt volně dostupnou haproxy, jejíž instance běží ve stejnojmenném kontejneru.
Hostovací stroj totiž standardně nemůže přistupovat na kontejnery prostřednictvím .lxd domény.
Bylo by možné sice mít proxy na hostovacím stroji, ale z bezpečnostních důvodů tak nebylo učiněno.

Do kontejneru haproxy je aktuálně přesměrována traffic ze čtyř portů -- 80, 443, 2222 a 3000.
Port 80 pochopitelně slouží na webové stránky pomocí protokolu http.
443 je pro https, proxy má nastavený ssl certifikát.
Ten stačí jeden pro celý systém, musí se však jednat o certifikát typu wildcard\footnote{certifikát, který zahrnuje i subdomény}.
Systém byl testován na standardním certifikátu, čily připojení sice bylo zabezpečené, ale prohlížeč hlásil podezření z fishningu, jelikož se doména a doména na certifikátu neschodovali.
Port 2222 slouží na připojení přes ssh, port 22 používá hostovací stroj a z pochopitelných důvodů není přesměrován do proxy.
Port 3000 je dostupný pro REST API aplikací, které na serveru budou běžet.

Kotejnerům je automaticky přirazena doména v následujícím tvaru \textit{\{jméno kotejneru\}.\{jméno projekty\}.\{část emailu uživatel, před @\}.\{doména serveru\}}.
Například kontejner pojmenovaný \textit{rumburak} v projektu \textit{web} uživatele \textit{belzebub@email.com} na serveru s doménou \textit{avava.cz} bude mít doménu {rumburak.web.belzebub.avava.cz}.
Mezery ve jméně kontejneru, či projektu se domény odstraní.
Pokud by měl nový kontejner stejné jméno, jako jiný systém vyhodí výjimku.
Tak je zaručena unikátnost domén, u mailu není takový problém nutno řešit, jelikož se jedná o školní emaily, které jsou vždy unikátní.

Bohužel je možno elegantně forwardovat pouze http protokol.
Většina TCP protokolů totiž neoperuje s SNI a řídí se pouze doménu.
Z packetu tak nejde zjistit na jakou doménu se uživatel snaží dostat a tedy jakému kontejneru mý být protokol přiřazen.
To by se týkalo i ssh, příkaz ssh však podporuje nastavit pomocí flagu -o ProxyCommand (viz. \ref{fig:sshcom}), packety poté sni v hlavičce mají a je možno poznat jakému kontejneru patří.
\begin{figure}[h]
\begin{lstlisting}[breaklines]
ssh -o ProxyCommand="openssl s_client -connect $SERVERURL:2222 -servername $CONTAINERURL" blank -l $USERNAME
\end{lstlisting}
\caption{příkaz k připojení na server\protect\footnotemark}
\label{fig:sshcom}
\end{figure}
\footnotetext{\$SERVERURL je url hostovacího server, \$CONTAINERURL je url kontejneru, \$USERNAME je jméno uživatel, argument dummy je ingnorován, je však potřeba}

Porty jako 8443 aktuálně forwardovány nejsou, pokud uživatel potřebuje přistupovat do datáze běžící na kontejneru je možno použít ssh local port forwarding.
Tento princip je i bezpečnější.

Konfigurační soubor HAProxy je generován v containerSQL.js.
Po jeho vygenerování se prostřednictvím lxd.postFileToInstance pošle nová konfigurace to HAProxy kontejneru.
Restartování proxy je téměř instantní operace i s velkým konfiguračním souborem obsahujícím desítky kontejnerů.
Downtime je tak minimální.
Podoba konfigurace byla realizována za pomocí dokumentace HAProxy\footnote{\bibentry{HaproxyDocs}}.
Aktuálně má však formát configu jisté rezervy, do jeho délka.
Je však o trochu rychlejší než, kdyby byly použity pokročilé metody mapování, které HAProxy podporuje.


% \chapter{Obrázky systému}
% \begin{figure}[h]
% 	\centering
% 		\includegraphics[height=8cm]{../img/dataatad.jpg}
% 		\caption[Obrazovka při běhu programu]{
% 		Obrazovka při běhu programu
% 	}
% \end{figure}

% \begin{figure}[h]
% 	\centering
% 		\includegraphics[height=8cm]{../img/sys.jpg}
% 		\caption[Obrazovka s 2 moduly M5Stack]{
% 		Obrazovka s 2 moduly M5Stack
% 	}
% \end{figure}

\chapter*{}
\pagenumbering{roman}
\setcounter{page}{6}
\include{zaver}

\include{literatura}

\listoffigures
\openright
\end{document}
